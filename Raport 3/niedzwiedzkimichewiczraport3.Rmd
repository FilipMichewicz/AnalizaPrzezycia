---
title: "Raport 3"
author: "Wiktor Niedźwiedzki, Filip Michewicz"
date: "28 stycznia 2026 Anno Domini"
classoption: a4paper, 12pt
geometry: top=2.5cm, bottom=2.5cm, left=2cm, right=2cm
output: 
  pdf_document:
    toc: true
    fig_caption: yes
    fig_width: 5
    fig_height: 4
    number_sections: true
    includes:
        in_header: "preamble.tex"
lof: true
lot: true
---

```{r biblioteki+zmienne_pomocnicze, include=FALSE}
library(knitr)
library(ggplot2)
library(survival)
library(survminer)
library(eha)
library(coin)
library(xtable)
library(gridExtra)
library(timereg)
library(latex2exp)

knitr::opts_chunk$set(fig.align='center', 
                      fig.pos='H', 
                      #dev='png', 
                      dpi=1200, 
                      fig.width = 6, 
                      fig.height = 3.5,
                      echo=FALSE)

# ZMNIEJSZENIE FONTÓW GLOBALNIE
theme_set(
  theme_minimal() +
    theme(
      axis.text  = element_text(size = 7),
      axis.title = element_text(size = 8),
      legend.text  = element_text(size = 7),
      legend.title = element_text(size = 8)
    )
)

na.patients <- apply(lung, 1, FUN = function(x) sum(is.na(x))>0)
lung1 <- lung
lung1$status <- as.factor(lung$status)
lung1$sex <- as.factor(lung$sex)
lung1$ph.ecog <- as.factor(lung$ph.ecog)
```

\newpage
# Dane *lung*

Każda lista zadań wykorzystuje dane *lung* z pakietu *survival* w pakiecie R, które dotyczą pacjentów z zaawansowanym rakiem płuc.

Zbiór danych *lung* zawiera **`r nrow(lung)`** oraz **`r ncol(lung)`** cech. Liczba brakujących danych wynosi **`r sum(is.na(lung))`**, z czego przypada ona na **`r sum(na.patients)`** pacjentów.

Znaczenie poszczególnych cech oraz ich typ przedstawiono w \hyperref[tab:opis_danych]{Tabeli \ref*{tab:opis_danych}.}

```{r opis_danych}
df_table <- data.frame(
  Typ = sapply(lung1, class),
  Opis = c("Kod instytucji",
           "Czas przeżycia w dniach",
           "Cenzura (1 - cenzura, 2 - śmierć (dana kompletna))",
           "Wiek w latach",
           "Płeć (1 - mężczyzna, 2 - kobieta)",
           "Skala ECOG według lekarza",
           "Ocena pacjenta w skali Karnofsky’ego według lekarza",
           "Ocena pacjenta w skali Karnofsky’ego według pacjenta,",
           "Kalorie spożywane podczas posiłków",
           "Utrata masy ciała w ciągu ostatnich sześciu miesięcy")
)

kable(df_table,
      col.names = c("Zmienna", "Typ", "Opis"),
      caption = "\\label{tab:opis_danych}Opis zmiennych w zbiorze danych lung")
```

* Skala (sprawności) Karnofsky’ego - skala pozwalająca określić stan ogólny i jakość życia pacjenta z chorobą nowotworową kwalifikowanego do chemioterapii bądź radioterapii. Skala ma rozpiętość od 100 do 0, gdzie 100 oznacza stan idealny, a 0 – śmierć. Skala opracowana przez Davida A. Karnofsky'ego oraz Josepha H. Burchenala w 1949 roku \cite{karnofsky}.
* Skala (sprawności) ECOG - skala pozwalająca określić stan ogólny i jakość życia pacjenta z chorobą nowotworową, ale stosowana też w geriatrii i psychiatrii, lub innych ciężkich i przewlekłych chorobach \cite{ecog}.

Porównanie skali ECOG ze skalą Karnofsky’ego:

* **ECOG 0** – 100, 90
* **ECOG 1** – 80, 70
* **ECOG 2** – 60, 50
* **ECOG 3** – 40, 30
* **ECOG 4** – 20, 10
* **ECOG 5** – 0

\newpage
# Lista 9

Lista skupia się na poznaniu modelów przyspieszonego czasu awarii oraz proporcjonalnych hazardów.

Niech $S_0(x)$ oraz $h_0(x)$ będą odpowiednio funkcjami przeżycia oraz hazardu o znanych postaciach, które odpowiadają rozkładowi obserwowalnej zmiennej losowej $X$ o zerowym wektorze charakterystyk. W przypadku zadań funkcje te będą odpowiadać rozkładowi Weibulla, jednakże można też przyjąć inne, co zostało uwzględnione w poniższych opisach.

## Model przyspieszonego czasu awarii (AFT)

Modelem, w którym funkcja przeżycia $S(x|z)$ jednostki o wektorze charakterystyk $z$ ma postać
$$
S(x|z) = S_0\left(\exp\left(\beta^T z\right)x\right),
$$
nazywamy modelem przyspieszonego czasu awarii (AFT - ang. *accelerated failure time*).  
Funkcję $S_0(x)$ nazywamy bazową funkcją przeżycia, natomiast wyrażenie $\exp\left(\beta^T z\right)$ — czynnikiem przyspieszenia (skalującym czas).

Model AFT posiada następującą interpretację. Jeżeli $z_1$ oraz $z_2$ są dwoma wektorami charakterystyk, to prawdopodobieństwo przeżycia czasu $x$ przez jednostkę o charakterystyce $z_1$ jest równe prawdopodobieństwu przeżycia czasu $\exp\left(\beta^T (z_1 - z_2)\right)x$ przez jednostkę o charakterystyce $z_2$. Oznacza to, że porównanie jednostek sprowadza się do odpowiedniego przeskalowania osi czasu.

W szczególności:

- jeżeli $\exp\left(\beta^T (z_1 - z_2)\right) > 1$ (tj. $\beta^T (z_1 - z_2) > 0$), to jednostka o charakterystyce $z_1$ ma większe prawdopodobieństwo wystąpienia zdarzenia przed chwilą $x$ niż jednostka o charakterystyce $z_2$,
- jeżeli $\exp\left(\beta^T (z_1 - z_2)\right) < 1$ (tj. $\beta^T (z_1 - z_2) < 0$), to jednostka o charakterystyce $z_1$ ma mniejsze prawdopodobieństwo wystąpienia zdarzenia przed chwilą $x$ niż jednostka o charakterystyce $z_2$,
- w szczególności, gdy $\exp\left(\beta^T (z_1 - z_2)\right) = 1$ (tj. $\beta^T (z_1 - z_2) = 0$), mamy $z_1 = z_2$.

Korzystając z zależności
$$
h(x) = -\frac{S'(x)}{S(x)},
$$
model AFT można równoważnie zapisać w postaci
$$
h(x|z) = h_0\left(\exp\left(\beta^T z\right)x\right)\exp\left(\beta^T z\right).
$$

W praktyce, jako bazową funkcję przeżycia $S_0(x)$ w modelu AFT często przyjmuje się funkcję odpowiadającą rozkładowi Weibulla (w szczególnym przypadku rozkładowi wykładniczemu), Gompertza, lognormalnemu, logistycznemu oraz rozkładowi wartości ekstremalnych.

## Model proporcjonalnych hazardów (PH)

W (parametrycznym) modelu proporcjonalnych hazardów (PH – ang. *proportional hazards*) funkcja hazardu $h(x | z)$ jednostki o wektorze charakterystyk $z$ ma postać

$$
h(x | z) = h_0(x)\exp\left(\beta^T z\right),
$$

gdzie $h_0(x)$ oznacza bazową funkcję hazardu, a wektor parametrów $\beta$ opisuje wpływ charakterystyk na intensywność wystąpienia zdarzenia.

Model proporcjonalnych hazardów zawdzięcza swoją nazwę bezpośrednio interpretacji. Jeżeli
$z_1 = (z_{11}, z_{12}, \dots, z_{1p})^T$
oraz
$z_2 = (z_{21}, z_{22}, \dots, z_{2p})^T$
są dwoma wektorami charakterystyk, to
$$
\frac{h(x | z_1)}{h(x | z_2)} = \exp\left(\beta^T (z_1 - z_2)\right),
$$
czyli iloraz hazardów dwóch jednostek nie zależy od czasu $x$, a jedynie od różnicy ich charakterystyk. Oznacza to, że hazardy są proporcjonalne w całym horyzoncie obserwacji.

Korzystając z zależności pomiędzy funkcją hazardu a funkcją przeżycia
$$
S(x) = \exp\left(-\int_0^x h(u)\,du\right),
$$
model PH można równoważnie zapisać w postaci funkcji przeżycia:
$$
S(x | z)
= \exp\left(-\int_0^x h_0(u)\exp\left(\beta^T z\right)\,du\right)
= \left[S_0(x)\right]^{\exp\left(\beta^T z\right)},
$$
gdzie $S_0(x) = \exp\left(-\int_0^x h_0(u)\,du\right)$ jest bazową funkcją przeżycia.

W praktyce, jako bazową funkcję hazardu $h_0(x)$ w modelu PH często przyjmuje się funkcję odpowiadającą rozkładowi Weibulla (w szczególnym przypadku rozkładowi wykładniczemu), model o kawałkami stałym hazardzie, rozkład Gompertza oraz rozkład wartości ekstremalnych.

## Zadanie 1

W tym zadaniu oszacowano parametry modelu przyspieszonego czasu awarii (AFT). Jako zmienną zależną przyjęto *time*, natomiast jako wektor charakterystyk: *age*, *sex*, *ph.ecog* oraz *ph.karno*. Do estymacji modelu wykorzystano funkcję `survreg` z pakietu `survival`.

Podczas konstruowania modelu uwzględniono fakt, że zmienne *sex* oraz *ph.ecog* mają charakter jakościowy (typ `factor`), natomiast zmienne *age* i *ph.karno* zostały poddane centrowaniu. Zabieg ten jest zalecany, gdyż poprawia własności numeryczne estymacji oraz interpretowalność parametrów modelu.

**UWAGA**: 
Po ograniczeniu zbioru danych, od tego momentu każdorazowe odwołanie do wartości w skali ECOG będzie dotyczyło zmiennej *ph.ecog*, czyli oceny nadawanej przez lekarza. Analogicznie, stopień w skali Karnofsky’ego będzie oznaczał wartość zmiennej *ph.karno*, również ustalaną przez lekarza.

Po wyznaczeniu odpowiedniego podzbioru danych usunięto obserwacje zawierające braki danych. Liczba usuniętych wierszy wyniosła **`r nrow(lung) - nrow(na.omit(lung[c("time", "status", "age", "sex", "ph.ecog", "ph.karno")]))`**.

```{r lung-aft, echo=TRUE}
lung_new <- na.omit(lung[c("time", "status", "age", "sex", "ph.ecog", "ph.karno")])

# Centrowanie danych
age_average <- mean(lung_new$age)
lung_new$age_new <- lung_new$age - age_average
ph.karno_average <- mean(lung_new$ph.karno)
lung_new$ph.karno_new <- lung_new$ph.karno - ph.karno_average

# Tworzenie modelu AFT
model.aft <- survreg(
  Surv(time, status) ~ age_new + as.factor(ph.ecog) +
    ph.karno_new + as.factor(sex),
  data = lung_new,
  dist = "weibull"
)
```

W poniższej tabeli przedstawiono współczynniki modelu. Ich interpretacja znajduje się w kolejnym zadaniu.

```{r aft-współczynniki}
df <- data.frame(beta = -model.aft$coefficients)
rownames(df) <- c("Wyraz wolny",
                  "Wiek",
                  "ECOG 1",
                  "ECOG 2",
                  "ECOG 3",
                  "Stopień Karnofsky'ego",
                  "Płeć = 2 (kobieta)")
df$expbeta <- exp(df$beta)

kable(
  df,
  col.names = c(
    "Charakterystyka",
    "Wartość współczynnika $\\beta$",
    "exp($\\beta$)"
  ),
  digits = 3,
  caption = "\\label{tab:aft_wspolczynniki} Współczynniki modelu AFT"
)

```

## Zadanie 2

W tym zadaniu zinterpretowane zostały wyznaczone współczynniki dla poszczególnych zmiennych. Współczynniki zostały przedstawione w \hyperref[tab:aft_wspolczynniki]{Tabeli \ref*{tab:aft_wspolczynniki}.}

Interpretacja współczynników w modelu przyspieszonego czasu awarii (AFT) opiera się na czynniku przyspieszenia czasu, czyli wartości $\text{exp}(\beta)$.

Wartości $\text{exp}(\beta_i) > 1$ oznaczają przyspieszenie wystąpienia zdarzenia (skrócenie czasu przeżycia), natomiast $\text{exp}(\beta_i) < 1$ oznaczają spowolnienie zdarzenia (wydłużenie czasu przeżycia) w porównaniu z jednostką odniesienia.

Wyraz wolny odpowiada bazowej funkcji przeżycia dla jednostki referencyjnej, której zmienne objaśniające przyjmują wartości odniesienia: wiek i stopień Karnofsky’ego równy średniej w próbce (po centrowaniu), ECOG = 0 oraz płeć męska. Wtedy przewidywany czas przeżycia tej jednostki opisuje funkcja

$$
S_0\left(\exp\left(\beta^T z_0\right) \, t\right),
$$

gdzie $z_0$ oznacza wektor zmiennych objaśniających przy wartościach odniesienia, a 
$\exp(\beta^T z_0) = `r round(df$expbeta[1], 3)`$ pełni rolę czynnika skalującego oś czasu względem bazowej funkcji $S_0(t)$.

Współczynniki modelu AFT działają multiplikatywnie na przewidywany czas przeżycia: przewidywany czas jednostki o charakterystykach $z$ jest skalowany względem jednostki referencyjnej przez czynnik $\exp(\beta^T z) = \exp(\beta_1 z_1) \cdot \exp(\beta_2 z_2) \cdot \dots \cdot \exp(\beta_p z_p)$. Oznacza to, że efekty wszystkich zmiennych łączą się poprzez mnożenie, wpływając jednocześnie na przewidywany czas przeżycia.

Po odpowiednich obliczeniach można pokazać, że wartość ilorazu prawdopdobieństw zgonu w chwili $x$ dla charakterystyk $z_1$ oraz $z_2$ jest zależna od czasu, tym samym nie jest ona stała.

$$
\frac{S\left(x|z_1\right)}{S\left(x|z_2\right)} = 
\exp\left(\left(\left(\frac{\exp\left(\beta^Tz_2\right)}{\lambda}\right)^k -
\left(\frac{\exp\left(\beta^Tz_1\right)}{\lambda}\right)^k \right)x^k\right)
$$

Oznacza to, że nie można podać konkretnego procentu o ile zwiększa się szansa przeżycia przy zmianie charakterystyki dla dowolnego $x$. Można jedynie podać różnicę w wartościach $x$ dla tej samej wartości prawdopodobieństwa zgonu.

W takim razie prawdopodobieństwo, że osoba A starsza o rok od osoby B przeżyje czas $x$ jest równe prawdopodobieństu, że osoba B przeżyje czas o $0.9\%$ dłuższy ($1.009x$). Starszy wiek zwiększa w każdej chwili szansę na zgon.

Wpływ stopnia sprawności ECOG na czas przeżycia jest bardzo wyraźny. Prawdopodobieństwo, że pacjent w stanie ECOG = 1 przeżyje czas $x$, odpowiada szansie na przeżycie czasu o 52,4% dłuższego ($1.524x$) przez pacjenta w pełni sprawnego (ECOG = 0). W przypadku stanu ECOG = 2, proces ten zachodzi jeszcze szybciej – czas $x$ u chorego odpowiada aż 252,5% tego czasu u osoby sprawnej. Największą różnicę widać dla grupy ECOG = 3, gdzie dany poziom ryzyka osiągany w czasie $x$ jest równy poziomowi ryzyka sprawnego pacjenta w momencie ponad pięciokrotnie większym ($5.405x$).

Każdy punkt mniej w skali Karnofsky'ego względem średniej zwiększa szacowany czas przeżycia o prawdopodobieństwie $p$ o $1\%$.

Prawdopodobieństwo na zgon mężczyzny w chwili $x$ wynosi tyle samo, co szansa na śmierć kobiety w momencie $\frac{x}{0.665} \approx 1.504x$.

## Zadanie 3

W tym zadaniu oszacowano funkcję przeżycia (w dniach) dla 70-letniej kobiety o stopniu sprawności fizycznej ECOG równym 1 oraz stopniu Karnofsky'ego równym 90. Dane ciągłe zostały wcześniej zcentrowane względem średnich w próbie.

```{r aft-przeżycie, echo=TRUE}
beta_aft <- unname((-model.aft$coefficients[-1]))
z <- c(70 - age_average, 1, 0, 0, 90 - ph.karno_average, 1)

mi <- unname(model.aft$coefficients[1])
sigma <-  model.aft$scale
alpha_aft <- 1 / sigma
lambda_aft <- exp(-alpha_aft * mi)

surv_fun_aft <- function(t, z) {
  theta_aft <- c(t(beta_aft) %*% z)
  exp(-lambda_aft * exp(alpha_aft * theta_aft) * t^alpha_aft)
}
```

Na podstawie oszacowanej funkcji przeżycia można obliczyć prawdopodobieństwo, że czas życia kobiety przekroczy 300 dni. Estymacja wynosi **`r round(100 * surv_fun_aft(300, z), 2)` %**.

## Zadanie 4

W tym zadaniu narysowano wykres estymowanej funkcji przeżycia z zadania 3.

```{r aft-przeżycie-wykres, fig.cap="\\label{fig:aft_przeżycie} Estymacja funkcji przeżycia - model AFT"}
t <- seq(0, 1500, length.out = 150000)
df <- data.frame(t = t, "y" = surv_fun_aft(t, z))
df_point <- data.frame(t = 300, y = surv_fun_aft(300, z))
ggplot(df, aes(x = t)) +
  geom_line(aes(y = y), lwd = 0.7, color = "steelblue") +
  geom_point(aes(x = t, y = y),
             df_point,
             size = 3,
             color = "limegreen") +
  labs(x = "Czas do zgonu (t)", y = "S(t|z)")
```

Na \hyperref[fig:aft_przeżycie]{Wykresie \ref*{fig:aft_przeżycie}.} widać, że szacowane prawdopodobieństwo przeżycia szybko maleje do ok. 500 dni, potem zaś prędkość ta znacząco maleje. Od czasu $t=1138$ estymowana szansa przeżycia spada poniżej 1%. Zielonym punktem zaznaczona została wcześniej wymieniona wartość estymowanego prawdopodobieństwa, że zgon kobiety nie nastąpi przed 300 dniem.

## Zadanie 5

W tym zadaniu oszacowano parametry modelu proporcjonalnych hazardów (PH). Podobnie jak wcześniej, zmienną zależną jest *time*, a zmiennymi objaśniającymi: *age*, *sex*, *ph.ecog* oraz *ph.karno*. Podobnie jak wcześniej, zmienne jakościowe traktowane są jako `factor`, natomiast zmienne ciągłe zostały zcentrowane.

```{r ph, echo=TRUE}
model.ph <- phreg(
  Surv(time, status) ~ age_new + as.factor(ph.ecog) +
    ph.karno_new + as.factor(sex),
  data = lung_new,
  dist = "weibull"
)
```

W poniższej tabeli przedstawiono współczynniki modelu. Ich interpretacja znajduje się w kolejnym zadaniu.

```{r ph-współczynniki}
df <- data.frame(beta = model.ph$coefficients)
rownames(df) <- c(
  "Wiek",
  "ECOG 1",
  "ECOG 2",
  "ECOG 3",
  "Stopień Karnofsky'ego",
  "Płeć = 2 (kobieta)",
  "log(scale)",
  "log(shape)"
)
df$expbeta <- exp(df$beta)

kable(
  df,
  col.names = c(
    "Charakterystyka",
    "Wartość współczynnika $\\beta$",
    "exp($\\beta$)"
  ),
  digits = 3,
  caption = "\\label{tab:ph_wspolczynniki} Współczynniki modelu PH"
)
```

## Zadanie 6

W tym zadaniu zinterpretowane zostały wyznaczone współczynniki dla poszczególnych zmiennych. Współczynniki zostały przedstawione w \hyperref[tab:ph_wspolczynniki]{Tabeli \ref*{tab:ph_wspolczynniki}.}

Interpretacja współczynników w modelu PH opiera się na ilorazie hazardów, czyli wartości $\text{exp}(\beta)$. Wartości $\text{exp}(\beta_i) > 1$ oznaczają zwiększenie ryzyka wystąpienia zdarzenia (wyższy hazard), natomiast $\text{exp}(\beta_i) < 1$ oznaczają zmniejszenie ryzyka (niższy hazard) w porównaniu z jednostką odniesienia.

Jednostka odniesienia to hipotetyczna jednostka, dla której wszystkie zmienne jakościowe przyjmują wartości referencyjne (ECOG = 0, mężczyzna), a zmienne ciągłe są ustawione na wartości średnie w próbie (po centrowaniu). Współczynniki $\beta$ opisują więc zmianę hazardu jednostki w stosunku do tej jednostki odniesienia.

Każdy dodatkowy rok życia zwiększa hazard zgonu o około 1,2% ($\exp(0.012) \approx 1.012$). 

W porównaniu z ECOG = 0 osoby z ECOG = 1 mają hazard większy o około 79,5% ($\exp(0.585) \approx 1.795$), z ECOG = 2 - o około 261,5% ($\exp(1.285) \approx 3.615$), a z ECOG = 3 – o około 939,4% ($\exp(2.341) \approx 10.394$). Wyższe wartości ECOG oznaczają znacznie wyższe ryzyko zdarzenia, czyli krótszy przewidywany czas przeżycia.

Każdy punkt wyższy w skali Karnofsky’a zwiększa hazard o około 1,4% ($\exp(0.014) \approx 1.014$). 

W porównaniu z mężczyznami, kobiety mają hazard mniejszy o około 43% ($\exp(-0.567) \approx 0.567$), co oznacza dłuższy przewidywany czas przeżycia.  

Parametry `log(scale)` i `log(shape)` określają odpowiednio skalę i kształt bazowego rozkładu Weibulla przyjętego w modelu.

## Zadanie 7

W tym zadaniu oszacowano dwie funkcje hazardu (w dniach) odpowiadające rozkładowi czasu życia 70-letnich kobiet o tej samej wartości stopnia Karnofsky’ego równym 90 oraz zróżnicowanej wartości charakterystyki ECOG wynoszących 1 oraz 2. Dane ciągłe zostały wcześniej zcentrowane względem średnich w próbie. Następnie porównano uzyskane estymacje funkcji hazardu.

Funkcje hazardu oszacowano w modelu proporcjonalnych hazardów z rozkładem Weibulla. Współczynniki regresji odpowiadają poszczególnym cechom jednostek, natomiast parametry kształtu i skali definiują bazową funkcję hazardu Weibulla:

$$
h(t \mid z) = h_0(t) \, \exp(\beta^T z),
$$

gdzie bazowy hazard Weibulla jest określony wzorem:

$$
h_0(t) = \lambda \, \alpha \, t^{\alpha - 1}, \quad 
\lambda = \exp(-\text{log(scale)} \cdot \alpha), \quad
\alpha = \exp(\text{log(shape)}).
$$

Wektor $z$ zawiera wartości zmiennych objaśniających zcentrowanych względem średnich oraz zakodowanych zmiennych jakościowych. Bazowy hazard $h_0(t)$ opisuje tempo ryzyka w jednostce odniesienia (dla wszystkich zmiennych jakościowych przyjmujących wartości referencyjne i zmiennych ciągłych ustawionych na średnich), natomiast współczynniki $\beta$ skalują go dla jednostek o innych wartościach cech.

```{r ph-hazard, echo=TRUE}
beta_ph <- unname(model.ph$coefficients[-c(7, 8)])
alpha_ph <- exp(model.ph$coefficients[["log(shape)"]])
mu <- model.ph$coefficients[["log(scale)"]]
lambda_ph <- exp(-mu * alpha_ph)

# 1 kobieta: ph.ecog=1
z1 <- c(70 - age_average, 1, 0, 0, 90 - ph.karno_average, 1)
theta_ph1 <- c(t(beta_ph) %*% z)

# 2 kobieta: ph.ecog=2
z2 <- c(70 - age_average, 0, 1, 0, 90 - ph.karno_average, 1)

hazard_fun_ph <- function(t, z) {
  theta_ph <- c(t(beta_ph) %*% z)
  lambda_ph * alpha_ph * t^(alpha_ph - 1) * exp(theta_ph)
}
```

```{r ph-hazard-wykres, fig.cap="\\label{fig:ph_hazard} Estymowane funkcje hazardu dla odpowiednich charakterystyk 70-letnich kobiet - model PH"}
t <- seq(0, 1500, length.out = 10000)
df <- data.frame("t" = t,
                 "h1" = hazard_fun_ph(t, z1),
                 "h2" = hazard_fun_ph(t, z2)
                 )
df$log_h1 <- log(df$h1)
df$log_h2 <- log(df$h2)
df$diff.log <- df$log_h1 - df$log_h2

ggplot(df, aes(x = t)) +
  geom_line(aes(y = h1, color = "h1"), lwd = 0.7) +
  geom_line(aes(y = h2, color = "h2"), lwd = 0.7) +
  scale_color_manual(
    name = "ECOG",
    values = c("h1" = "steelblue", "h2" = "tomato"),
    labels = c("1", "2")
  ) +
  labs(x = "Czas do zgonu (t)", y = "h(t|z)") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Z \hyperref[fig:ph_hazard]{Wykresu \ref*{fig:ph_hazard}.} można odczytać, że funkcja hazardu dla kobiety o charakterystyce ECOG równej 2 jest zawsze wyższa niż dla tej drugiej. Oznacza to, że w jej przypadku ryzyko zgonu w każdym momencie jest wyższe.

```{r ph-hazard-wykres-log, fig.cap="\\label{fig:ph_hazard_log} Logarytmy estymowanych funkcji hazardu dla odpowiednich charakterystyk 70-letnich kobiet - model PH"}
ggplot(df, aes(x = t)) +
  geom_line(aes(y = log_h1, color = "y1"), lwd = 0.7) +
  geom_line(aes(y = log_h2, color = "y2"), lwd = 0.7) +
  scale_color_manual(
    name = "ECOG",
    values = c("y1" = "steelblue", "y2" = "tomato"),
    labels = c("1", "2")
  ) +
  labs(x = "Czas do zgonu (t)", y = "log(h(t|z))") +
  theme_minimal() +
  theme(legend.position = "bottom")
```
Poszczególne krzywe funkcji log-hazardu na \hyperref[fig:ph_hazard_log]{Wykresie \ref*{fig:ph_hazard_log}.} wydają się równoległe, co sugeruje, że iloraz hazardów może być stały w czasie.

```{r ph-hazard-wykres-log-diff, fig.cap="\\label{fig:ph_hazard_log_diff} Różnica logarytmów estymowanych funkcji hazardu dla odpowiednich charakterystyk 70-letnich kobiet - model PH", warning=FALSE}
ggplot(df, aes(x = t, y = diff.log)) +
  geom_line(color = "tomato", lwd = 0.7) +
  labs(x = "Czas do zgonu (t)", y = "Różnica logarytmów h(t|z)") +
  theme_minimal() +
  theme(legend.position = "none")
```

Jak pokazano na \hyperref[fig:ph_hazard_log_diff]{Wykresie \ref*{fig:ph_hazard_log_diff}.} różnica logarytmów funkcji hazardu jest w przybliżeniu stała w czasie, co wskazuje na stałość ilorazu hazardów. W konsekwencji brak jest przesłanek empirycznych do odrzucenia założenia proporcjonalnych hazardów, a przyjęcie modelu proporcjonalnych hazardów w analizie można uznać za uzasadnione.

## Zadanie 8

W tym zadaniu, w oparciu o wcześniej wyznaczone funkcje hazardu w modelu proporcjonalnych hazardów z bazowym rozkładem Weibulla, wyznaczono odpowiadające im funkcje przeżycia.

Dla rozkładu Weibulla oraz parametryzacji zastosowanej w modelu proporcjonalnych hazardów otrzymujemy bazową funkcję przeżycia

$$
S_0(t) = \exp\left(- \lambda t^{\alpha} \right),
$$

natomiast funkcja przeżycia dla jednostki o wektorze cech (z) przyjmuje postać

$$
S(t|z) = \left[S_0(t)\right]^{\exp(\beta^T z)}
= \exp\left(- \lambda t^{\alpha} \exp(\beta^T z)\right).
$$

```{r ph-przeżycie, echo = TRUE}
surv_fun_ph <- function(t, z) {
  theta_ph <- c(t(beta_ph) %*% z)
  exp(-lambda_ph*t^alpha_ph*exp(theta_ph))
}
```

W oparciu o wyznaczone funkcje przeżycia obliczono estymowane prawdopodobieństwo, że kobiety przeżyją ponad 300 dni. Dla kobiety o stopniu sprawności w skali ECOG równym 2 wynosi ono **`r round(100*surv_fun_ph(300, z2),2)`%**, natomiast dla kobiety o stopniu sprawności w skali ECOG równym 1 — **`r round(100*surv_fun_ph(300, z1),2)`%**.  

Otrzymana wartość dla kobiety o stopniu sprawności w skali ECOG równym 1 jest równa estymacji uzyskanej przy zastosowaniu modelu AFT. Sugeruje to, że oba modele definiują taki sam rozkład pomimo odmiennej interpretacji współczynników $\beta$. W przypadku modelu proporcjonalnych hazardów są one związane z multiplikatywną zmianą funkcji hazardu, a w modelu przyspieszonego czasu awarii odpowiednio przyspieszają lub opóźniają zdarzenie.

## Zadanie 9

W tym zadaniu porównano funkcje przeżycia uzyskane za pomocą modeli AFT oraz PH dla 70-letniej kobiety o stopniu sprawności w skali Karnofsky’ego równym 90 oraz stopniu sprawności w skali ECOG równym 1.

```{r aftVSph-wykres, fig.cap="\\label{fig:aftVSph} Porównanie estymowanych funkcji przeżycia - modele AFT oraz PH"}
t <- seq(0, 1500, length.out = 10000)
df <- data.frame(t = t,
                 s1 = surv_fun_aft(t, z1),
                 s2 = surv_fun_ph(t, z1))
df_points <- data.frame(t = c(300, 300),
                        s = c(surv_fun_aft(300, z1), surv_fun_ph(300, z1)))

ggplot(df, aes(x = t)) +
  geom_line(aes(y = s1, color = "s1"), lwd = 0.7) +
  geom_line(aes(y = s2, color = "s2"), lwd = 0.7) +
  geom_point(aes(x = t, y = s),
             df_points,
             size = 3,
             color = c("limegreen", "purple")) +
  scale_color_manual(
    name = "Model",
    values = c("s1" = "steelblue", "s2" = "tomato"),
    labels = c("AFT", "PH")
  ) +
  labs(x = "Czas do zgonu (t)", y = "S(t|z)") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

\hyperref[fig:aftVSph]{Wykres \ref*{fig:aftVSph}.} wskazuje idealne pokrycie rozkładów uzyskanych za pomocą modeli AFT oraz PH. To z kolej potwierdza nasze poprzednie przypuszczenia o uzyskanej matematycznej równoważności. Wynika ona bezpośrednio z faktu, że rozkład Weibulla jest jedynym rozkładem prawdopodobieństwa, który posiada jednocześnie cechę proporcjonalności hazardów oraz strukturę przyspieszonego czasu życia. Tym samym powoduje to brak zmiany kształtu funkcji przeżycia.

Ze względu na uzyskane pokrycie, w dalszej części raportu wyniki będą porównywane jedynie z modelem AFT-PH, gdyż w tym szczególnym pzypadku modele są identyczne.

\newpage
# Lista 10

Lista polega na praktycznym zastosowaniu modelu proporcjonalnych hazardów Coxa do danych o czasie przeżycia. Celem jest oszacowanie parametrów modelu, interpretacja wpływu zmiennych na ryzyko zdarzenia, wyznaczenie bazowej funkcji hazardu i funkcji przeżycia, a także ocena prawdopodobieństwa przeżycia dla wybranych profili pacjentów oraz weryfikacja założeń modelu poprzez wizualizacje.

## Model proporcjonalnych hazardów Coxa

Modelem, w którym funkcja hazardu jednostki o charakterystyce $z$ ma postać  

$$
h_z(t) = h_0(t) \psi(z),
$$  

nazywamy modelem proporcjonalnych hazardów Coxa. Funkcja $h_0(t)$ to bazowa funkcja hazardu, zależna od czasu, ale niezależna od charakterystyk, przyjmująca wartości nieujemne. Funkcja $\psi(z)$ zależy wyłącznie od wektora charakterystyk $z$, jest nieujemna i zwykle przyjmuje postać parametryczną  

$$
\psi(z) = \exp(\beta^T z),
$$  

gdzie $\beta$ to wektor nieznanych współczynników modelu. Wówczas funkcja hazardu przyjmuje postać  

$$
h_z(t) = h_0(t) \exp(\beta^T z),
$$  

co pozwala interpretować wpływ zmiennych objaśniających na ryzyko wystąpienia zdarzenia w sposób względny.  

Ryzyko względne między jednostką o charakterystyce $z_1$ a jednostką o charakterystyce $z_2$ definiuje się jako  

$$
\frac{h_{z_1}(t)}{h_{z_2}(t)} = \exp[\beta^T (z_1 - z_2)],
$$  

czyli jest stałe w czasie i zależy tylko od różnicy charakterystyk. Dzięki temu nazwa modelu – proporcjonalne hazardy – odzwierciedla fakt, że hazardy jednostek są proporcjonalne w całym okresie obserwacji.

Mimo że model proporcjonalnych hazardów Coxa przypomina parametryczny model proporcjonalnych hazardów (PH), podstawowa różnica polega na tym, że w modelu Coxa nie zakłada się konkretnej postaci bazowego hazardu $h_0(t)$. W modelu AFT-PH bazowy hazard jest parametrycznie określony, natomiast w modelu Coxa pozostaje nieznany i może mieć dowolny kształt, co sprawia, że estymacja współczynników $\beta$ jest oparta wyłącznie na względnych hazardach i obserwowanych czasach przeżycia.

## Zadanie 1

Zadanie polega na oszacowaniu parametrów modelu proporcjonalnych hazardów Coxa. Jako zmienną zależną przyjęto *time*, natomiast jako wektor charakterystyk: *age*, *sex*, *ph.ecog* oraz *ph.karno*. Do estymacji modelu wykorzystano funkcję `coxph` z pakietu `survival`.

```{r cox-model-nie-jablka, echo=TRUE}
model.cox <- coxph(Surv(time, status) ~ age_new + 
                     as.factor(ph.ecog) + ph.karno_new + as.factor(sex),
                   data = lung_new)
```

W poniższej tabeli przedstawiono współczynniki modelu. Ich interpretacja znajduje się w kolejnym zadaniu.

```{r}
df <- data.frame(beta = model.cox$coefficients)
rownames(df) <- c("Wiek",
                  "ECOG 1",
                  "ECOG 2",
                  "ECOG 3",
                  "Stopień Karnofsky'ego",
                  "Płeć = 2 (kobieta)")

df$expbeta <- exp(df$beta)

kable(
  df,
  col.names = c(
    "Charakterystyka",
    "Wartość współczynnika $\\beta$",
    "exp($\\beta$)"
  ),
  digits = 3,
  caption = "\\label{tab:cox_coef} Współczynniki modelu Coxa"
)
```

## Zadanie 2

W tym zadaniu zinterpretowane zostały wyznaczone współczynniki dla poszczególnych zmiennych. Współczynniki zostały przedstawione w \hyperref[tab:cox_coef]{Tabeli \ref*{tab:cox_coef}.} Interpretacja współczynników $\beta_i$ w modelu Coxa opiera się na ryzyku względnym i hazardzie. Ryzyko względne jednostki o charakterystyce przesuniętej o jeden punkt względem średniej próbki wynosi $\exp(\beta_i)$. Oznacza to, że funkcja hazardu tej jednostki jest równa funkcji hazardu jednostki o średnich wartościach charakterystyk pomnożonej przez $\exp(\beta_i)$, niezależnie od czasu.

Dla wieku każda jednostka wieku powyżej średniego wieku zwiększa hazard zgonu o około 1.3% ($\beta = 0.01256$, $\exp(\beta) \approx 1.0126$).

Hazard zgonu kobiety jest około 43% mniejszy niż hazard mężczyzny ($\beta = -0.5657$, $\exp(\beta) \approx 0.568$).

Jednostka z ECOG równym 1 ma hazard zgonu około 78% wyższy niż jednostka z ECOG równym 0 ($\beta = 0.5781$, $\exp(\beta) \approx 1.783$). Jednostka z ECOG równym 2 ma hazard ponad trzykrotnie większy niż jednostka z ECOG równym 0 ($\beta = 1.2399$, $\exp(\beta) \approx 3.455$), a jednostka z ECOG równym 3 ma hazard niemal 11-krotnie wyższy ($\beta = 2.3959$, $\exp(\beta) \approx 10.978$).

Dla stopnia Karnofsky'ego każdy punkt powyżej średniego wyniku zwiększa hazard zgonu o około 1.25% ($\beta = 0.01242$, $\exp(\beta) \approx 1.0125$).

Efekty są multiplikatywne, zmiana w jednej zmiennej mnoży bazowy hazard $h_0(t)$ przez $\exp(\beta_i)$, a zmiany w różnych zmiennych działają razem poprzez iloczyn tych czynników, określając całkowity hazard jednostki.

## Zadanie 3

Zadanie polega na oszacowaniu bazowej funkcji hazardu oraz bazowej funkcji przeżycia.  

W przypadku modelu Coxa funkcja przeżycia jednostki o charakterystyce $z$ ma postać  

$$
S_z(t) = \left[S_0(t)\right]^{\exp(\beta^T z)}.
$$

Oszacowanie bazowej funkcji przeżycia uzyskuje się na podstawie oszacowanej bazowej funkcji hazardu  

$$
\hat{S}_0(t) = \exp\left[-\int_0^t \hat{h}_0(u)\,du\right] = \exp\left[-\hat{H}_0(t)\right].
$$

Do oszacowania bazowej funkcji hazardu wykorzystuje się estymator Breslowa oparty na metodzie cząstkowej wiarogodności  

$$
\hat{H}_0(t) = \sum_{\tau_i \le t} \frac{1}{\sum_{j \in R(\tau_i)} \exp(\hat{\beta^T} z_j)},
$$

gdzie $R(\tau_i)$ jest zbiorem ryzyka, czyli jednostek znajdujących się w ryzyku w chwili $\tau_i$. 

W pakiecie R w bibliotece `survival` estymację tę realizuje funkcja `basehaz()`.

```{r basehaz_surv, echo=TRUE}
basehaz_df <- basehaz(model.cox)

surv_df <- data.frame(surv = exp(-basehaz_df$hazard), time = basehaz_df$time)
```

## Zadanie 4

Zadanie polega na oszacowaniu bazowych skumulowanych funkcji hazardu (w dniach) odpowiadajacych rozkładowi czasu życia dwóch 70-letnich kobiet o tej samej wartości stopnia Karnofsky’ego równym 90 oraz zróżnicowanej wartości charakterystyki ECOG wynoszących 1 oraz 2. Dane ciągłe zostały wcześniej zcentrowane względem średnich w próbie. Następnie porównano uzyskane estymacje skumulowanej funkcji hazardu.

W modelu Coxa skumulowana funkcja hazardu jednostki o charakterystyce $z$ wyraża się wzorem

$$
{H}_z(t) = {H}_0(t) \cdot \exp({\beta^T} z),
$$
Ten wzór wynika bezpośrednio z definicji modelu Coxa:

$$
h_z(t) = h_0(t) \exp(\beta^T z) \quad \Rightarrow \quad H_z(t) = \int_0^t h_z(u)du = \int_0^t h_0(u) du \cdot \exp(\beta^T z) = H_0(t) \exp(\beta^T z).
$$


```{r cum_hazard, echo=TRUE}
cum_hazard <- function(model, z) {
  basehazard <- basehaz(model)
  hazard <- basehazard$hazard * exp(sum(model$coefficients * z))
  data.frame(time = basehazard$time, hazard = hazard, loghazard = log(hazard))
}

cum_hazard_1 <- cum_hazard(model.cox, z1)
cum_hazard_2 <- cum_hazard(model.cox, z2)

```

```{r hazardplot1, fig.cap="Estymowana skumulowana funkcja hazardu dla odpowiednich charakterystyk 70-letnich kobiet - model Cox'a"}
ggplot() +
  geom_line(data = cum_hazard_1, aes(x = time, y = hazard, color = "h1"), lwd = 0.7) +
  geom_line(data = cum_hazard_2, aes(x = time, y = hazard, color = "h2"), lwd = 0.7) +
  scale_color_manual(
    name = "Model",
    values = c("h1" = "steelblue", "h2" = "tomato"),
    labels = c("ECOG 1", "ECOG 2")
  ) +
  labs(x = "Czas do zgonu (t)", y = expression(hat(H)(t))) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Z \hyperref[fig:hazardplot1]{Wykresu \ref*{fig:hazardplot1}.} można odczytać że skumulowany hazard dla kobiety o charakterystyce ECOG równej 2, jest większy niż dla kobiety o charakterystyce ECOG równej 1, co oznacza, że do danego momentu czasu kobieta z gorszym stanem ogólnym zdrowia (ECOG = 2) zgromadziła większe łączne ryzyko zgonu, a w konsekwencji odpowiadająca jej funkcja przeżycia przyjmuje mniejsze wartości w porównaniu z funkcją przeżycia kobiety o charakterystyce ECOG = 1.

```{r hazardplot2, fig.cap="Logarytm estymowanej skumulowanej funkcja hazardu dla odpowiednich charakterystyk 70-letnich kobiet - model Cox'a"}
ggplot() +
  geom_line(data = cum_hazard_1, aes(x = time, y = loghazard, color = "h1"), lwd = 0.7) +
  geom_line(data = cum_hazard_2, aes(x = time, y = loghazard, color = "h2"), lwd = 0.7) +
  scale_color_manual(
    name = "Model",
    values = c("h1" = "steelblue", "h2" = "tomato"),
    labels = c("ECOG 1", "ECOG 2")
  ) +
  labs(x = "Czas do zgonu (t)", y = expression(log(hat(H)(t)))) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Na \hyperref[fig:hazardplot2]{Wykresie \ref*{fig:hazardplot2}.} można zobaczyć, że logarytmy skumulowanej funkcji hazardu mają bardzo podobny kształt i wyglądają jakby były względem siebie przesunięte o stałą wartość w górę, co jest zgodne z założeniem modelu proporcjonalnych hazardów, zgodnie z którym różnica logarytmów skumulowanych hazardów nie zależy od czasu.

```{r hazardplot3, fig.cap="Różnica logarytmów estymowanej skumulowanej funkcji hazardu dla odpowiednich charakterystyk 70-letnich kobiet - model Cox'a"}
logdiff <- data.frame(time = cum_hazard_1$time, logdiff = cum_hazard_1$loghazard - cum_hazard_2$loghazard)

ggplot(logdiff, aes(x = time, y = logdiff)) +
  geom_line(color = "tomato", lwd = 0.7) +
  labs(x = "Czas do zgonu (t)", y = expression("Różnica logarytmów " * hat(H)(t))) +
  theme_minimal()
```
Na \hyperref[fig:hazardplot3]{Wykresie \ref*{fig:hazardplot3}.} przedstawiono różnicę logarytmów skumulowanej funkcji hazardu, która dla wszystkich argumentów pozostaje stała, oznacza to, że iloraz skumulowanych hazardów nie zależy od czasu. 

Można łatwo pokazać, że w modelu Coxa zachodzi

$$
\frac{H_{z_1}(t)}{H_{z_2}(t)}
= \frac{\exp\left(\beta^T z_1\right) H_0(t)}{\exp\left(\beta^T z_2\right) H_0(t)}
= \exp\left(\beta^T \left(z_1 - z_2\right)\right)
= \frac{h_{z_1}(t)}{h_{z_2}(t)}.
$$

Po zlogarytmowaniu otrzymujemy

$$
\log H_{z_1}(t) - \log H_{z_2}(t)
= \beta^T \left(z_1 - z_2\right) = \log h_{z_1}(t) - \log h_{z_2}(t),
$$

czyli różnica logarytmów skumulowanych funkcji hazardu oraz różnica logarytmów funkcji hazardu jest stała w czasie.

W konsekwencji, na podstawie wykresów nie ma podstaw do wątpienia w poprawność przyjętego modelu proporcjonalnych hazardów, gdyż założenie proporcjonalności hazardów jest spełnione.

## Zadanie 5

Zadanie polega na oszacowaniu funkcji przeżycia (w dniach) odpowiadającej rozkładowi czasu życia 70-letnich kobiet o takiej samej o tej samej wartości stopnia Karnofsky’ego równym 90 oraz zróżnicowanej wartości charakterystyki ECOG wykoszącym 1 oraz 2. Dane ciągłe zostały wcześniej zcentrowane względem średnich w próbie.

```{r zadanie_piedź, echo=TRUE}
surv_cox <- function(model, z){
  basehaz <- basehaz(model)
  hazard <- basehaz$hazard * exp(sum(model$coefficients * z))
  surv <- exp(-hazard)
  data.frame(time = basehaz$time, survival = surv)
}

surv_at_time_cos <- function(surv_df, t) {
  idx <- which.min(abs(surv_df$time - t))
  surv_df$survival[idx]
}

df_surv_z1 <- surv_cox(model.cox, z1)
df_surv_z2 <- surv_cox(model.cox, z2)
```

```{r coxy, fig.cap="Estymacja funkcji przeżycia w modelu Coxa dla różnych charakterystyk pacjentek"}
df_points <- data.frame(time = c(300, 300),
                        surv = c(surv_at_time_cos(df_surv_z1, 300), surv_at_time_cos(df_surv_z2, 300)))

ggplot() +
  geom_line(data = df_surv_z1, aes(x = time, y = survival, color = "1."), lwd = 0.7) +
  geom_line(data = df_surv_z2, aes(x = time, y = survival, color = "2."), lwd = 0.7) +
  geom_point(aes(x = time, y = surv),
             df_points,
             size = 3,
             color = c("limegreen", "purple")) +
  scale_color_manual(
    name = "Pacjentka",
    values = c("1." = "steelblue", "2." = "tomato")
  ) +
  labs(x = "Czas do zgonu (t)", y = "S(t|z)") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Na \hyperref[fig:coxy]{Wykresie \ref*{fig:coxy}.} widać różne funkcje przeżycia dla różnych charakterystyk pacjentek. Prawdopodobieństwo przeżycia kobiety o niższej charakterystyce ECOG jest większe dla każdego czasu.

```{r tabela_porownawcza}
df.table <- data.frame(
  Pacjentka = c("Pacjentka 1", "Pacjentka 2"),
  "AFT-PH" = 100*c(surv_fun_ph(300, z1), surv_fun_ph(300, z2)),
  COX  = 100*c(surv_at_time_cos(df_surv_z1, 300), surv_at_time_cos(df_surv_z2, 300))
)

knitr::kable(
  df.table,
  col.names = c("", "AFT-PH", "Cox"),
  caption = "\\label{tab:porownanie}Estymowana funkcja przeżycia dla czasu t = 300 w procentach - porównanie modeli AFT-PH oraz Coxa",
  digits = 2
)
```

Porównując prawdopodobieństwa z \hyperref[tab:porownanie]{Tabeli  \ref*{tab:porownanie}.}, można dojść do wniosku, że estymowane prawdopodobieństwa wartości dla modeli AFT-PH i Cox są do siebie bardzo zbliżone. To może sugerować, że nawet mimo braku założenia konkretnego rozkładu w modelu Coxa, wyniki są zbliżone do tych uzyskanych przy ustalonym z góry rozkładzie Weibulla.

## Zadanie 6

W tym zadaniu narysowano wykresy estymowanej funkcji przeżycia dla 70-letniej kobiety o stopniu sprawności fizycznej ECOG równym 1 oraz stopniu Karnofsky równym 90 dla modeli AFT-PH oraz Coxa.

```{r gomboc1, fig.cap="Porównanie estymowanych funkcji przeżycia - modele AFT-PH oraz Coxa"}
t <- seq(0, max(df_surv_z1$time), length.out = 10000)
df <- data.frame(t = t,
                 s = surv_fun_ph(t, z1))

ggplot() +
  geom_line(data = df, aes(x = t, y = s, color = "AFT-PH"), lwd = 0.7) +
  geom_line(data = df_surv_z1, aes(x = time, y = survival, color = "Cox"), lwd = 0.7) +
  scale_color_manual(
    name = "Model",
    values = c("AFT-PH" = "steelblue", "Cox" = "tomato")
  ) +
  labs(x = "Czas do zgonu (t)", y = "S(t|z)") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

\hyperref[fig:gomboc1]{Wykres \ref*{fig:gomboc1}.} wskazuje zbliżoną do siebie estymację prawdopodobieństw uzyskaną modelami Coxa i AFT-PH. To z kolei sugeruje, że założenie dotyczące rozkładu Weibulla było prawidłowe.

\newpage
# Lista 11

Celem listy jest zastosowanie modelu PO. Analiza uwzględnia: oszacowanie parametrów modelu, interpretację wpływu zmiennych na ryzyko zdarzenia, wyznaczenie bazowych funkcji skumulowanego hazardu i funkcji przeżycia oraz wyznaczenie wartości prawdopodobieństw dla wybranych profili pacjentów.

## Model proporcjonalnych szans (PO)

Modelem proporcjonalnych szans nazywamy model, w którym szansę na wystąpienie zdarzenia (iloraz prawdopodobieństwa sukcesu do prawdopodobieństwa porażki) dla jednostki o charakterystyce $z$ w chwili $t$ określamy wzorem

$$
\theta_z(t) = \frac{1-S_z(t)}{S_z(t)}.
$$

Model ten jest stosowany, kiedy założenie proporcjonalności hazardów nie jest spełnione i jest on semiparametryczny, gdyż nie zakładamy konkretnego rozkładu jednostki o zerowym wektorze charakterystyk oraz nie znamy wartości współczynników $\beta$. Po ich wyznaczeniu jednakże możemy określić dokładniejsze wzory na $\theta_z$:

$$
\theta_z(t)=\theta_0(t)\exp\left(\beta^Tz\right)\text{,  gdzie  }
\theta_0(t) = \frac{1-S_0(t)}{S_0(t)}.
$$

Ze wzoru wynika też prosta interpretacja, mamy bowiem

$$
\frac{\theta_{z_1}(t)}{\theta_{z_2}(t)} = \exp\left(\beta^T(z_1-z_2)\right), \\
\phantom{} \\
\ln \frac{\theta_{z_1}(t)}{\theta_{z_2}(t)} = \beta^T(z_1-z_2),
$$

czyli iloraz szans dwóch jednostek o dowolnych charakterystykach $z_1$, $z_2$ jest stały i niezależny od czasu.

Przyjmując model proporcjonalnych szans, możemy dla jednostki o charakterystyce $z$ wyznaczyć postać funkcji przeżycia

$$
S_z(t)=\frac{1}{1+\theta_z(t)}=\frac{1}{1+\theta_0(t)\exp\left(\beta^Tz\right)}
$$

oraz funkcji hazardu

$$
h_z(t)=-\frac{S_z'(t)}{S_z(t)}=\frac{\theta_z'(t)}{1+\theta_z(t)}=\frac{\theta_0'(t)}{1+\theta_0(t)\exp\left(\beta^Tz\right)}
$$

## Zadanie 1

Zadanie polega na oszacowaniu parametrów modelu PO. Jako zmienną zależną przyjęto *time*, natomiast jako wektor charakterystyk: *age*, *sex*, *ph.ecog* oraz *ph.karno*. Do estymacji modelu wykorzystano funkcję `prop.odds` z pakietu `timereg`. Dane ciągłe zostały zcentrowane. Dodatkowo, ze względu na specyfikację funkcji, zmieniono oznaczenia statusu danych na 0 - obserwacja cenzurowana oraz 1 - dana kompletna.

```{r lung-odds, echo=TRUE}
lung_new$status_new <- lung_new$status - 1
model.odds <- prop.odds(Event(time, status_new) ~ age_new +
                                                  as.factor(ph.ecog) +
                                                  ph.karno_new +
                                                  as.factor(sex),
                        data = lung_new)
```

W tabeli poniżej przedstawione są estymowane wartości współczynników.

```{r lung-współczynniki}
df <- data.frame(beta = unname(model.odds$gamma))
rownames(df) <- c("Wiek",
                  "ECOG 1",
                  "ECOG 2",
                  "ECOG 3",
                  "Stopień Karnofsky'ego",
                  "Płeć = 2 (kobieta)")
df$expbeta <- exp(df$beta)

kable(
  df,
  col.names = c(
    "Charakterystyka",
    "Wartość współczynnika $\\beta$",
    "exp($\\beta$)"
  ),
  digits = 3,
  caption = "\\label{tab:odds_wspolczynniki} Współczynniki modelu PO"
)
```

## Zadanie 2

W tym zadaniu zinterpretowane zostały wyznaczone współczynniki dla poszczególnych zmiennych znajdujące się w \hyperref[tab:odds_wspolczynniki]{Tabeli \ref*{tab:odds_wspolczynniki}.} Interpretacja opiera się na ilorazie estymowanych szans. Oznacza to, że jeśli $k$-ta zmienna (charakterystyka) wzrośnie o jedną jednostkę (przy ustalonych pozostałych zmiennych), to szansa na wystąpienie zdarzenia zwiększa się (zostaje przemnożona) o czynnik $\exp(\beta_k)$, niezależnie od ustalonego czasu $t$.

W naszym przypadku badanym zdarzeniem jest śmierć pacjenta. Oznacza to, że większa wartość szansy w chwili $t$ jest równoznaczna z większą szansą na zgon przed tym momentem.

W przypadku wieku każdy dodatkowy rok życia zwiększa szansę na zgon o około 1,3% ($\exp(0.013) \approx 1.013$).

Zmiana skali ECOG z wartości 0 na wartość 1 powoduje wzrost szansy na śmierć o prawie 73% ($\exp(0.547) \approx 1.728$). W przypadku wartości ECOG = 2 szansa ta wzrasta ponad czterokrotnie ($\exp(1.4466) \approx 4.249$), a dla ECOG = 3 prawie siedmiokrotnie ($\exp(1.925) \approx 6.852$).

Wzrost skali Karnofsky'ego o jeden punkt powoduje zmniejszenie szansy śmierci o ok.  0.4% ($\exp(-0.004) \approx 0.996$).

Szansa kobiet na śmierć przed chwilą $t$ jest około 2,6 raza mniejsza niż w przypadku mężczyzn ($\exp(0.9535)\approx 2.597$).

## Zadanie 3

Zadanie polega na oszacowaniu wartości skumulowanej funkcji hazardu oraz funkcji przeżycia. W tym celu zastosowano funkcję `predict` z pakietu `stats` do wyznaczenia bazowej funkcji przeżycia. Następnie wykorzystano zależność $H(t)=-\log\left(S(t)\right)$.

```{r odds_bazowe, echo=TRUE}
S_0 <- predict(model.odds, Z=rep(0, 6))
base <- data.frame("time"=S_0$time,
                "S0"=c(S_0$S0),
                "H0"=c(-log(S_0$S0)))
```

## Zadanie 4

W tym zadaniu oszacowano wartości i narysowano wykresy skumulowanych funkcji hazardu dla 70-letnich kobiet o stopniu Karnofsky'ego równym 90 oraz stopniu sprawności fizycznej ECOG równym odpowiednio 1 lub 2. Dokonano również porównania uzyskanych wyników z estymowanymi wartościami dla modelu proporcjonalnych hazardów Coxa.

W tym celu napisano funkcję, która dla danego wektora charakterystyk $z$ wylicza estymowane wartości funkcji przeżycia, skumulowanego hazardu oraz dodatkowo szans.

```{r, echo=TRUE}
beta_odds <- unname(model.odds$gamma)

surv_cum_haz_fun_odds <- function(z) {
  theta_odd <- exp(sum(beta_odds*z))
  df <- data.frame("time" = base$time,
                   "S" = 1 / (1 + (1-base$S0)/base$S0 * theta_odd))
  df$H <- -log(df$S)
  df$odds <- (1-df$S)/df$S
  df
}
```

Tworzymy ramki danych dla odpowiednich wektorów charakterystyk $z$.

```{r, echo=TRUE}
Z1 <- surv_cum_haz_fun_odds(c(70-age_average, 1, 0, 0, 90-ph.karno_average, 1))
Z2 <- surv_cum_haz_fun_odds(c(70-age_average, 0, 1, 0, 90-ph.karno_average, 1))
```

```{r hazardplot4, fig.cap="Estymowana skumulowana funkcja hazardu dla odpowiednich charakterystyk 70-letnich kobiet - modele Coxa i PO"}
cum_hazard_1_subset <- cum_hazard_1[cum_hazard_1$time <= max(Z1$time),]
cum_hazard_2_subset <- cum_hazard_2[cum_hazard_2$time <= max(Z1$time),]

ggplot() +
  geom_line(aes(x=time, y=H, color="PO; 1"), Z1, lwd=0.7) +
  geom_line(aes(x=time, y=H, color="PO; 2"), Z2, lwd=0.7) +
  geom_line(aes(x=time, y=hazard, color="Cox; 1"), cum_hazard_1_subset, lwd=0.7) +
  geom_line(aes(x=time, y=hazard, color="Cox; 2"), cum_hazard_2_subset, lwd=0.7) +
  scale_color_manual(
    name = "Model; ECOG",
    values = c("PO; 1" = "steelblue",
               "PO; 2" = "tomato",
               "Cox; 1" = "darkgreen",
               "Cox; 2" = "gold2")
  ) +
  labs(x = "Czas do zgonu (t)", y = "H(t|z)") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

\hyperref[fig:hazardplot4]{Wykres \ref*{fig:hazardplot4}.} pokazuje, że dla modelu PO estymowane wartości funkcji skumulowanego hazardu są systematycznie niższe niż te uzyskane w modelu proporcjonalnych hazardów Coxa. Dla kobiety o stopniu sprawności fizycznej ECOG równym 1 różnica ta wydaje się być w przybliżeniu stała. Jednakże przy skali ECOG równej 2 rozbieżność ta jest znacznie wyraźniejsza i narasta wraz z upływem czasu.

Wyniki te oznaczają, że model PO szacuje mniejsze skumulowane ryzyko zgonu niż model Coxa, co bezpośrednio implikuje, że wyznaczane w nim prawdopodobieństwa przeżycia ($\hat{S}(t) = \exp(-\hat{H}(t))$) będą wyższe.

Ze względu na to, że nałożenie logarytmu jest przekształceniem monotonicznym (zachowuje relację porządku między grupami), a celem kolejnego kroku jest analiza relacji wewnątrz modelu PO, następny wykres pominie funkcje związane z modelem Coxa.

```{r hazardplot5, fig.cap="Logarytm estymowanej skumulowanej funkcji hazardu dla odpowiednich charakterystyk 70-letnich kobiet - model PO"}
Z1_log <- Z1[Z1$H>0,]
Z1_log$logH <- log(Z1_log$H)
Z2_log <- Z2[Z2$H>0,]
Z2_log$logH <- log(Z2_log$H)

ggplot() +
  geom_line(aes(x=time, y=logH, color="1"), Z1_log, lwd=0.7) +
  geom_line(aes(x=time, y=logH, color="2"), Z2_log, lwd=0.7) +
  scale_color_manual(
    name = "ECOG",
    values = c("1" = "steelblue", "2" = "tomato")
  ) +
  labs(x = "Czas do zgonu (t)", y = "log(H(t|z))") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Z \hyperref[fig:hazardplot5]{Wykresu \ref*{fig:hazardplot5}.} można wnioskować, że różnica logarytmów skumulowanych funkcji hazardu (a tym samym iloraz tych funkcji) nie jest stała, lecz zmienia się w czasie $t$.

```{r hazardplot6, fig.cap="Różnica logarytmów estymowanej skumulowanej funkcji hazardu dla odpowiednich charakterystyk 70-letnich kobiet - model PO"}
df <- data.frame("time"=Z1_log$time,
                     "difference"=abs(Z1_log$logH-Z2_log$logH))
ggplot(df, aes(x=time)) +
  geom_line(aes(y=difference), df, lwd=0.7, color="tomato") +
  labs(x = "Czas do zgonu (t)", y = expression("Różnica logarytmów " * hat(H)(t))) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

\hyperref[fig:hazardplot6]{Wykres \ref*{fig:hazardplot6}.} potwierdza nasze poprzednie przypuszczenia. Należy jednak pamiętać, że model PO, jak sama nazwa wskazuje, zachowuje stałą wartość ilorazu estymowanych funkcji szans, a nie skumulowanych funkcji hazardu. Model ten stosuje się, gdy drugi przypadek nie zachodzi.

## Zadanie 5

Celem zadania jest oszacować dla wcześniej wymienionych pacjentek prawdopodobieństwo, że ich czas życia będzie większy niż 300 dni, na podstawie modelu {proporcjonalnych szans}P. Dodatkowo dokonano porównania otrzymanych wyników z tymi uzyskanymi metodą proporcjonalnych hazardów Coxa.

```{r}
surv_at_time_odds <- function(surv_df, t) {
  min(surv_df$S[surv_df$time <= t])
}

df.table <- data.frame(
  Pacjentka = c("Pacjentka 1", "Pacjentka 2"),
  COX  = 100*c(surv_at_time_cos(df_surv_z1, 300), surv_at_time_cos(df_surv_z2, 300)),
  ODDS = 100*c(surv_at_time_odds(Z1, 300), surv_at_time_odds(Z2, 300))
)

knitr::kable(
  df.table,
  col.names = c("", "Cox", "PO"),
  caption = "\\label{tab:porownanie_odds}Estymowana funkcja przeżycia dla czasu t = 300 w procentach - porównanie modeli Coxa oraz PO",
  digits = 2
)
```

Porównanie wyników z \hyperref[tab:porownanie_odds]{Tabeli \ref*{tab:porownanie_odds}.} prowadzi do wniosku, że estymowane wartości prawdopodobieństwa przeżycia dla modelu proporcjonalnych szans są wyższe (korzystniejsze dla pacjentek) niż te dla modelu Coxa.

Potwierdza to również wniosek wysnuty na podstawie \hyperref[fig:hazardplot4]{Wykresu \ref*{fig:hazardplot4}.} - mniejszy skumulowany hazard oznacza mniejsze ryzyko, co bezpośrednio przekłada się na wyższe prawdopodobieństwo przeżycia. Ponadto, mniejsza różnica między funkcjami hazardu skutkuje mniejszą różnicą w szacowanych prawdopodobieństwach.

## Zadanie 6

W zadaniu narysowano wykres estymowanej funkcji przeżycia dla pacjentki o stopniu sprawności fizycznej ECOG równym 1 dla modelu proporcjonalnych szans oraz dokonano graficznego porównania z funkcją uzyskaną za pomocą modelu proporcjonalnych hazardów Coxa.

```{r gomboc2, fig.cap="Porównanie estymowanych funkcji przeżycia - modele Coxa oraz PO"}
t_max <- min(max(df_surv_z1$time), max(Z1$time))
t <- seq(0, t_max, length.out = 10000)
#df_ph <- data.frame(t = t,
#                    s = surv_fun_ph(t, z1))
df_cox <- df_surv_z1[df_surv_z1$time <= t_max,]
df_odds <- Z1[Z1$time <= t_max,]

ggplot() +
  geom_line(data = df_odds, aes(x = time, y = S, color = "PO"), lwd = 0.7) +
  geom_line(data = df_cox, aes(x = time, y = survival, color = "Cox"), lwd = 0.7) +
  scale_color_manual(
    name = "Model",
    values = c(PO = "steelblue", Cox = "tomato")
  ) +
  labs(x = "Czas do zgonu (t)", y = "S(x|z)") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

\hyperref[fig:gomboc2]{Wykres \ref*{fig:gomboc2}.} pokazuje, że estymowane wartości funkcji przeżycia są wyższe dla modelu PO niż dla modelu Coxa. Należy zauważyć, że różnica między nimi nie zmienia się gwałtownie, lecz narasta stopniowo wraz z upływem czasu, a nastepnie spada.

Biorąc pod uwagę wyniki uzyskane dla wszystkich analizowanych podejść, można przypuszczać, że widoczne rozbieżności w przypadku modelu PO mogą wynikać z jego nieadekwatnego dopasowania do danych. Model ten stosuje się bowiem w sytuacjach, gdy nie jest spełnione założenie proporcjonalności hazardów, które w przypadku naszych danych zostało jednak potwierdzone empirycznie.

\newpage
# Lista 12

Lista polega na analizie danych o czasie przeżycia z wykorzystaniem modeli przyspieszonego czasu awarii oraz proporcjonalnych hazardów Coxa. Celem jest ocena istotności zmiennych objaśniających przy użyciu testów Walda i testów ilorazu wiarogodności, weryfikacja hipotez dotyczących wpływu sprawności ECOG na rozkład czasu przeżycia oraz wybór najlepszego modelu z zastosowaniem procedur eliminacji zmiennych i kryteriów informacyjnych AIC oraz BIC.

## Zadanie 1

Zadanie polega na  weryfikacji istotności zmiennych `age` i `sex`, a także ocenie różnic w czasie przeżycia względem zmiennej `ph.ecog` w modelu przyspieszonego czasu awarii. W tym celu dla zmiennych `age` i `sex` przeprowadzono testy Walda oraz IW, natomiast dla zmiennej `ph.ecog` wykorzystano jedynie test IW, ponieważ jej wielokategorialny charakter wymaga weryfikacji łącznej istotności wszystkich parametrów opisujących tę zmienną. Poziom istotności wynosi $\alpha$ = 0.05.

```{r chlopiecurodzonywczwartek1, echo=TRUE}

p_wald_age <- summary(model.aft)[["table"]][, 4]["age_new"]
p_wald_sex <- summary(model.aft)[["table"]][, 4]["as.factor(sex)2"]

model.aft.age <- survreg(
  Surv(time, status) ~ as.factor(sex) + as.factor(ph.ecog) + ph.karno_new,
  data = lung_new,
  dist = "weibull"
)

model.aft.sex <- survreg(
  Surv(time, status) ~ age_new + as.factor(ph.ecog) + ph.karno_new,
  data = lung_new,
  dist = "weibull"
)

model.aft.ecog <- survreg(
  Surv(time, status) ~ age_new + as.factor(sex) + ph.karno_new,
  data = lung_new,
  dist = "weibull"
)

p_iw_age <- anova(model.aft, model.aft.age)[2, "Pr(>Chi)"]
p_iw_sex <- anova(model.aft, model.aft.sex)[2, "Pr(>Chi)"]
p_iw_ecog <- anova(model.aft, model.aft.ecog)[2, "Pr(>Chi)"]

df <- data.frame(
  Zmienna = c("Age", "Sex", "ECOG"),
  Wald = c(p_wald_age, p_wald_sex, NA),
  IW = c(p_iw_age, p_iw_sex, p_iw_ecog)
)
```

```{r chlopiecurodzonywczwartek2}
options(knitr.kable.NA = '-')

kable(
  df,
  col.names = c("Zmienna usuwana", "p-value (Wald)", "p-value (IW)"),
  digits = 4,
  caption = "\\label{tab:testy_istotnosci}Weryfikacja istotności zmiennych age, sex oraz ph.ecog w modelu AFT",
  row.names = FALSE,
  na = "-"
)
```

W \hyperref[tab:testy_istotnosci]{Tabeli \ref*{tab:testy_istotnosci}.} przedstawiono wyniki weryfikacji hipotez, z których wynika, że na przyjętym poziomie istotności $\alpha = 0.05$ nie ma podstaw do odrzucenia hipotezy o nieistotności zmiennej `age`. Natomiast w przypadku zmiennych `sex` oraz `ph.ecog` wyniki testów wskazują na ich statystyczną istotność, co oznacza, że płeć oraz stopień sprawności fizycznej ECOG są czynnikami istotnie różnicującymi czas przeżycia w analizowanym modelu.

## Zadanie 2

Zadanie polega na weryfikacji istotności zmiennych `age` i `sex`, a także ocenie różnic w czasie przeżycia względem zmiennej `ph.ecog` w moelu proporcjonalnych hazardów Coxa. W tym celu dla zmiennych `age` i `sex` przeprowadzono testy Walda oraz IW, natomiast dla zmiennej `ph.ecog` wykorzystano jedynie test IW, ponieważ jej wielokategorialny charakter wymaga weryfikacji łącznej istotności wszystkich parametrów opisujących tę zmienną. Poziom istotności wynosi $\alpha$ = 0.05.

```{r chlopiecurodzonywczwartek3, echo=TRUE}
p_wald_age <- summary(model.cox)$coefficients["age_new", "Pr(>|z|)"]
p_wald_sex <- summary(model.cox)$coefficients["as.factor(sex)2", "Pr(>|z|)"]

model.cox.age <- coxph(
  Surv(time, status) ~ as.factor(sex) + as.factor(ph.ecog) + ph.karno_new,
                       data = lung_new)

model.cox.sex <- coxph(
  Surv(time, status) ~ age_new + as.factor(ph.ecog) + ph.karno_new,
                       data = lung_new)

model.cox.ecog <- coxph(
  Surv(time, status) ~ age_new + as.factor(sex) + ph.karno_new,
                        data = lung_new)

p_iw_age <- anova(model.cox, model.cox.age)[2, "Pr(>|Chi|)"]
p_iw_sex <- anova(model.cox, model.cox.sex)[2, "Pr(>|Chi|)"]
p_iw_ecog <- anova(model.cox, model.cox.ecog)[2, "Pr(>|Chi|)"]

df <- data.frame(
  Zmienna = c("Age", "Sex", "ECOG"),
  Wald = c(p_wald_age, p_wald_sex, NA),
  IW = c(p_iw_age, p_iw_sex, p_iw_ecog)
)
```

```{r chlopiecurodzonywczwartek4}
options(knitr.kable.NA = '-')

kable(
  df,
  col.names = c("Zmienna usuwana", "p-value (Wald)", "p-value (IW)"),
  digits = 4,
  caption = "\\label{tab:testy_istotnosci2}Weryfikacja istotności zmiennych age, sex oraz ph.ecog w modelu Coxa",
  row.names = FALSE,
  na = "-"
)
```

W \hyperref[tab:testy_istotnosci2]{Tabeli \ref*{tab:testy_istotnosci2}.} przedstawiono wyniki weryfikacji hipotez. Wnioski są dokładnie takie same jak przy testowaniu hipotez dla modelu AFT.

## Zadanie 3

W tym zadaniu dokonano wyboru optymalnego modelu przyspieszonego czasu awarii (AFT) z rozkładem Weibulla, stosując trzy różne metody selekcji zmiennych: eliminację wsteczną opartą na teście ilorazu wiarogodności, kryterium informacyjne Akaike’a (AIC) oraz bayesowskie kryterium informacyjne (BIC).

Procedura eliminacji wstecznej polega na rozpoczęciu od modelu pełnego, a następnie w kolejnych krokach usuwaniu zmiennej, która ma najmniej istotny wpływ na model (najwyższa wartość p-value w teście ilorazu wiarogodności), o ile wartość ta przekracza przyjęty poziom istotności. Zgodnie z zaleceniami dla selekcji zmiennych, przyjęto poziom istotności $\alpha = 0.15$ (co pozwala zachować zmienne potencjalnie istotne, choć słabsze).

```{r miodek, echo=TRUE}
# Krok 1.
model.aft.age <- survreg(
  Surv(time, status) ~ as.factor(sex) + as.factor(ph.ecog) + ph.karno_new,
  data = lung_new,
  dist = "weibull"
)

model.aft.sex <- survreg(
  Surv(time, status) ~ age_new + as.factor(ph.ecog) + ph.karno_new,
  data = lung_new,
  dist = "weibull"
)

model.aft.ecog <- survreg(
  Surv(time, status) ~ age_new + as.factor(sex) + ph.karno_new,
  data = lung_new,
  dist = "weibull"
)

model.aft.karno <- survreg(
  Surv(time, status) ~ age_new + as.factor(sex) + as.factor(ph.ecog),
  data = lung_new,
  dist = "weibull"
)

p_iw_age <- anova(model.aft, model.aft.age)[2, "Pr(>Chi)"]
p_iw_sex <- anova(model.aft, model.aft.sex)[2, "Pr(>Chi)"]
p_iw_ecog <- anova(model.aft, model.aft.ecog)[2, "Pr(>Chi)"]
p_iw_karno <- anova(model.aft, model.aft.karno)[2, "Pr(>Chi)"]

# Krok 2. usuwamy age

model.aft.sex2 <- survreg(
  Surv(time, status) ~ as.factor(ph.ecog) + ph.karno_new,
  data = lung_new,
  dist = "weibull"
)

model.aft.ecog2 <- survreg(
  Surv(time, status) ~ as.factor(sex) + ph.karno_new,
  data = lung_new,
  dist = "weibull"
)

model.aft.karno2 <- survreg(
  Surv(time, status) ~ as.factor(sex) + as.factor(ph.ecog),
  data = lung_new,
  dist = "weibull"
)

p_iw_sex2 <- anova(model.aft.age, model.aft.sex2)[2, "Pr(>Chi)"]
p_iw_ecog2 <- anova(model.aft.age, model.aft.ecog2)[2, "Pr(>Chi)"]
p_iw_karno2 <- anova(model.aft.age, model.aft.karno2)[2, "Pr(>Chi)"]

# Krok 3. usuwamy karno

model.aft.sex3 <- survreg(
  Surv(time, status) ~ as.factor(ph.ecog),
  data = lung_new,
  dist = "weibull"
)

model.aft.ecog3 <- survreg(
  Surv(time, status) ~ as.factor(sex),
  data = lung_new,
  dist = "weibull"
)

p_iw_sex3 <- anova(model.aft.karno2, model.aft.sex3)[2, "Pr(>Chi)"]
p_iw_ecog3 <- anova(model.aft.karno2, model.aft.ecog3)[2, "Pr(>Chi)"]

df <- data.frame(
  Zmienna = c("Age", "Sex", "ECOG", "Karnofsky"),
  "Krok 1." = c(p_iw_age, p_iw_sex, p_iw_ecog, p_iw_karno),
  "Krok 2." = c(NA, p_iw_sex2, p_iw_ecog2, p_iw_karno2),
  "Krok 3." = c(NA, p_iw_sex3, p_iw_ecog3, NA)
)
```

```{r miodek2}
kable(
  df,
  col.names = c("Zmienna usuwana", "Krok 1.", "Krok 2.", "Krok 3."),
  digits = 4,
  caption = "\\label{tab:eliminacja_aft}Dobór zmiennych do modelu AFT metodą eliminacji wstecznej",
  row.names = FALSE
)
```

W \hyperref[tab:eliminacja_aft]{Tabeli \ref*{tab:eliminacja_aft}.} przedstawiono kolejne kroki procedury doboru zmiennych metodą eliminacji wstecznej. W pierwszym etapie analizy modelu pełnego wskazano zmienną `age` jako czynnik o najmniejszej sile predykcyjnej, co przy przyjętym poziomie istotności skutkowało jej usunięciem. W kolejnym kroku, dla modelu zredukowanego, stwierdzono brak istotności statystycznej dla stopnia sprawności w skali Karnofsky'ego, w związku z czym ta zmienna również została wyeliminowana. W rezultacie w modelu końcowym pozostały jedynie zmienne `sex` oraz ECOG, dla których testy potwierdziły istotność statystyczną, co kończy procedurę selekcji.

W kolejnym kroku dokonano wyboru optymalnego modelu, minimalizując kryterium informacyjne Akaike’a (AIC). Kryterium to ocenia jakość dopasowania modelu do danych, nakładając karę za liczbę parametrów ($k=2$). Dobór polega na rozpoczęciu analizy od modelu pełnego, a następnie iteracyjnym usuwaniu tej zmiennej, której eliminacja prowadzi do największego spadku wartości AIC (poprawy dopasowania). Procedura ta jest powtarzana do momentu, w którym usunięcie jakiejkolwiek kolejnej zmiennej skutkowałoby wzrostem wartości kryterium, co oznacza osiągnięcie modelu optymalnego w sensie AIC. Analogiczny dobór wykorzystuje się dla bayesowskiego kryterium informacyjnego (BIC). Kryterium to nakłada surowszą karę za złożoność modelu, zależną od liczebności danych kompletnych w próbie ($k = \ln(n) = \ln(163) \approx 5.09$). Obydwie procedury przeprowadzono metodą krokową wsteczną przy użyciu funkcji `step`.

```{r miodek3, echo = TRUE, eval = FALSE}
model.aic <- step(model.aft, direction = "backward", k = 2)
model.bic <- step(model.aft, direction = "backward", 
                  k = log(nrow(lung_new[lung_new$status == 2,])))
```

Najlepsze model wskazany przez kryteria AIC oraz BIC są tożsame z tym wyznaczonym wcześniej za pomocą metody eliminacji.

Podsumowując, każda z zastosowanych metod selekcji jednoznacznie wskazuje, że najlepszy model zawiera tylko dwie zmienne objaśniające: `sex` oraz `ph.ecog`.

W poniższej tabeli przedstawiono współczynniki optymalnego modelu AFT.

```{r aft_opt, echo=TRUE}
model.aft.optimal <- survreg(
  Surv(time, status) ~ as.factor(ph.ecog) + as.factor(sex),
  data = lung_new,
  dist = "weibull"
)
```

```{r}
df <- data.frame(beta = -model.aft.optimal$coefficients)
rownames(df) <- c("Wyraz wolny",
                  "ECOG 1",
                  "ECOG 2",
                  "ECOG 3",
                  "Płeć = 2 (kobieta)")
df$expbeta <- exp(df$beta)

kable(
  df,
  col.names = c(
    "Charakterystyka",
    "Wartość współczynnika $\\beta$",
    "exp($\\beta$)"
  ),
  digits = 3,
  caption = "\\label{tab:aft_wspolczynniki_opt} Współczynniki modelu AFT - optymalnego"
)
```

Model końcowy, którego parametry zestawiono w \hyperref[tab:aft_wspolczynniki_opt]{Tabeli \ref*{tab:aft_wspolczynniki_opt}.}, w niewielkim stopniu różni się od modelu pełnego z \hyperref[tab:aft_wspolczynniki]{Tabeli \ref*{tab:aft_wspolczynniki}.} Wartości współczynników $\beta$ dla wyrazu wolnego oraz zmiennej płci uległy jedynie marginalnym zmianom. Zauważalna różnica wystąpiła w przypadku współczynników dla zmiennej ECOG, które przyjęły niższe wartości. Jest to zjawisko uzasadnione, ponieważ - jak wykazano we wstępie skala Karnofsky’ego zależy od skali ECOG, a sam wiek również ma wpływ na sprawność fizyczną. Interpretacja współczynników nie zmieniła się.

## Zadanie 4

W tym zadaniu dokonano wyboru optymalnego modelu Coxa, stosując trzy różne metody selekcji zmiennych: eliminację wsteczną opartą na teście ilorazu wiarogodności, kryterium informacyjne Akaike’a (AIC) oraz bayesowskie kryterium informacyjne (BIC).

Sposób doboru przedstawiono w Zadaniu 3. Zaczęto podobnie od metody eliminacji wstecznej.

```{r miodek5, echo=TRUE}
# Krok 1. 

model.cox.age <- coxph(
  Surv(time, status) ~ as.factor(sex) + as.factor(ph.ecog) + ph.karno_new,
                       data = lung_new)

model.cox.sex <- coxph(
  Surv(time, status) ~ age_new + as.factor(ph.ecog) + ph.karno_new,
                       data = lung_new)

model.cox.ecog <- coxph(
  Surv(time, status) ~ age_new + as.factor(sex) + ph.karno_new,
                        data = lung_new)

model.cox.karno <- coxph(
  Surv(time, status) ~ age_new + as.factor(sex) + as.factor(ph.ecog),
                        data = lung_new)

p_iw_age <- anova(model.cox, model.cox.age)[2, "Pr(>|Chi|)"]
p_iw_sex <- anova(model.cox, model.cox.sex)[2, "Pr(>|Chi|)"]
p_iw_ecog <- anova(model.cox, model.cox.ecog)[2, "Pr(>|Chi|)"]
p_iw_karno <- anova(model.cox, model.cox.karno)[2, "Pr(>|Chi|)"]

# Krok 2. usuwamy karno

model.cox.age2 <- coxph(
  Surv(time, status) ~ as.factor(sex) + as.factor(ph.ecog),
                       data = lung_new)

model.cox.sex2 <- coxph(
  Surv(time, status) ~ age_new + as.factor(ph.ecog),
                       data = lung_new)

model.cox.ecog2 <- coxph(
  Surv(time, status) ~ age_new + as.factor(sex),
                        data = lung_new)

p_iw_age2 <- anova(model.cox.karno, model.cox.age2)[2, "Pr(>|Chi|)"]
p_iw_sex2 <- anova(model.cox.karno, model.cox.sex2)[2, "Pr(>|Chi|)"]
p_iw_ecog2 <- anova(model.cox.karno, model.cox.ecog2)[2, "Pr(>|Chi|)"]

# Krok 3. usuwamy age

model.cox.sex3 <- coxph(
  Surv(time, status) ~ ph.karno_new,
                       data = lung_new)

model.cox.ecog3 <- coxph(
  Surv(time, status) ~ as.factor(sex),
                        data = lung_new)

p_iw_sex3 <- anova(model.cox.age2, model.cox.sex3)[2, "Pr(>|Chi|)"]
p_iw_ecog3 <- anova(model.cox.age2, model.cox.ecog3)[2, "Pr(>|Chi|)"]


df <- data.frame(
  Zmienna = c("Age", "Sex", "ECOG", "Karnofsky"),
  "Krok 1." = c(p_iw_age, p_iw_sex, p_iw_ecog, p_iw_karno),
  "Krok 2." = c(p_iw_age2, p_iw_sex2, p_iw_ecog2, NA),
  "Krok 3." = c(NA, p_iw_sex3, p_iw_ecog3, NA)
)
```

```{r miodek6}
kable(
  df,
  col.names = c("Zmienna usuwana", "Krok 1.", "Krok 2.", "Krok 3."),
  digits = 4,
  caption = "\\label{tab:eliminacja_cox}Dobór zmiennych do modelu Coxa metodą eliminacji wstecznej",
  row.names = FALSE
)
```

W \hyperref[tab:eliminacja_cox]{Tabeli \ref*{tab:eliminacja_cox}.} przedstawiono kolejne kroki procedury doboru zmiennych metodą eliminacji wstecznej. Procedura jest dokładnie taka sama jak w Zadaniu 3.

W następnej kolejności dokonano wyboru modelu stosująć kryterium AIC oraz BIC.

```{r miodek7, echo = TRUE, eval = FALSE}
model.aic <- step(model.cox, direction = "backward", k = 2)
model.bic <- step(model.aft, direction = "backward", 
                  k = log(nrow(lung_new[lung_new$status == 2,])))
```

Najlepsze model wskazany przez to kryterium AIC oraz BIC są tożsame z tym wyznaczonym wcześniej za pomocą metody eliminacji.

Podsumowując, każda z zastosowanych metod selekcji jednoznacznie wskazuje, że najlepszy model zawiera tylko dwie zmienne objaśniające: `sex` oraz `ph.ecog`.

W poniższej tabeli przedstawiono współczynniki optymalnego modelu Coxa.

```{r cox-opt, echo=TRUE}
model.cox.opt <- coxph(Surv(time, status) ~ as.factor(ph.ecog) +  
                         as.factor(sex), data = lung_new)
```

```{r}
df <- data.frame(beta = model.cox.opt$coefficients)
rownames(df) <- c("ECOG 1",
                  "ECOG 2",
                  "ECOG 3",
                  "Płeć = 2 (kobieta)")

df$expbeta <- exp(df$beta)

kable(
  df,
  col.names = c(
    "Charakterystyka",
    "Wartość współczynnika $\\beta$",
    "exp($\\beta$)"
  ),
  digits = 3,
  caption = "\\label{tab:cox_coef_opt} Współczynniki modelu Coxa - optymalnego"
)
```

Model końcowy, którego parametry zestawiono w \hyperref[tab:cox_coef_opt]{Tabeli \ref*{tab:cox_coef_opt}.}, w niewielkim stopniu różni się od modelu pełnego z \hyperref[tab:cox_coef]{Tabeli \ref*{tab:cox_coef}.} Wartość współczynnika $\beta$ dla płci uległa jedynie marginalnej zmianie. Zauważalna różnica wystąpiła w przypadku współczynników dla zmiennej ECOG, które przyjęły niższe wartości. Jest to zjawisko uzasadnione, ponieważ - jak wykazano we wstępie skala Karnofsky’ego zależy od skali ECOG, a sam wiek również ma wpływ na sprawność fizyczną. Interpretacja współczynników nie zmieniła się.


\newpage
# Bibliografia

\begin{thebibliography}{2}

\bibitem{karnofsky}
\textit{Skala Karnofsky’ego}, Wikipedia,  
\url{https://pl.wikipedia.org/wiki/Skala_Karnofsky’ego},  
dostęp: 22.12.2025.

\bibitem{ecog}
\textit{Skala ECOG}, Wikipedia,  
\url{https://pl.wikipedia.org/wiki/Skala_ECOG},  
dostęp: 22.12.2025.

\end{thebibliography}
